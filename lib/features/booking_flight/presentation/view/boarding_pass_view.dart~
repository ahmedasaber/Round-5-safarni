// presentation/views/pages/boarding_pass_view.dart
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:safarni/features/payment/presentation/views/pages/payment_method_view.dart';

import '../../../../core/utils/app_assets.dart';
import '../../../../core/utils/app_colors.dart';
import '../../../../core/utils/app_styles.dart';
import '../../data/datasource/boarding_pass_remote_data_source.dart';
import '../../data/repositories/boarding_pass_repository_impl.dart';
import '../../domain/usecases/boarding_pass.dart';
import '../cubit/flight_booking_cubit.dart';
import '../cubit/flight_booking_state.dart';

class BoardingPassView extends StatelessWidget {
  const BoardingPassView({super.key});

  static const routeName = "/boarding_pass";

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (_) => BoardingPassCubit(
        GetBoardingPass(
          BoardingPassRepositoryImpl(
            BoardingPassRemoteDataSourceImpl(Dio()),
          ),
        ),
      )..fetchBoardingPass(),
      child: Scaffold(
        backgroundColor: Colors.white,
        appBar: AppBar(
          backgroundColor: Colors.white,
          elevation: 0,
          leading: IconButton(
            icon: const Icon(Icons.arrow_back_ios, color: Colors.black),
            onPressed: () => Navigator.pop(context),
          ),
          title: const Text(
            'Boarding Pass',
            style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold),
          ),
          centerTitle: true,
        ),
        body: BlocBuilder<BoardingPassCubit, BoardingPassState>(
          builder: (context, state) {
            if (state is BoardingPassLoading) {
              return const Center(child: CircularProgressIndicator());
            } else if (state is BoardingPassLoaded) {
              final pass = state.boardingPass;
              return SingleChildScrollView(
                child: Padding(
                  padding: const EdgeInsets.all(TextStyles.defaultSpace - 8),
                  child: Column(
                    children: [
                      SizedBox(
                        height: 9,
                        child: Stack(
                          children: [
                            Positioned(
                              top: 0,
                              left: 0,
                              right: 0,
                              child: Image.asset(AppAssets.rectangularLine),
                            ),
                          ],
                        ),
                      ),
                      Card(
                        color: Colors.white,
                        elevation: 4,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(
                            TextStyles.borderRadiusLg + 4,
                          ),
                        ),
                        child: Padding(
                          padding: const EdgeInsets.all(TextStyles.defaultSpace - 8),
                          child: Column(
                            children: [
                              _buildTicketHeader(pass),
                              _buildFlightInfo(pass),
                              _buildDetailsSection(pass), // ثابت Gate, Terminal, Flight
                              const SizedBox(height: 20),
                              _buildUserSection(pass),
                              const SizedBox(height: 20),
                              Image.network(
                                pass.qrCodeUrl,
                                height: 200,
                                width: 200,
                                fit: BoxFit.contain,
                              ),
                              const SizedBox(height: 30),
                              SizedBox(
                                width: double.infinity,
                                child: ElevatedButton(
                                  onPressed: () {
                                    Navigator.of(context).pushReplacementNamed(
                                      PaymentMethodView.routeName,
                                    );
                                  },
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: AppColors.primaryColor,
                                    padding: const EdgeInsets.symmetric(vertical: 16),
                                    shape: RoundedRectangleBorder(
                                      borderRadius: BorderRadius.circular(12),
                                    ),
                                  ),
                                  child: const Text(
                                    'Checkout',
                                    style: TextStyle(fontSize: 18, color: Colors.white),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              );
            } else if (state is BoardingPassError) {
              return Center(child: Text(state.message));
            }
            return const SizedBox();
          },
        ),
      ),
    );
  }

  Widget _buildTicketHeader(pass) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Row(
          children: [
            Image.asset(AppAssets.canada, height: 30),
            const SizedBox(width: 8),
            Text(
              pass.airline,
              style: const TextStyle(fontWeight: FontWeight.w500, fontSize: 16),
            ),
          ],
        ),
        Text(
          pass.date,
          style: const TextStyle(color: AppColors.softGrey, fontWeight: FontWeight.w500),
        ),
      ],
    );
  }

  Widget _buildFlightInfo(pass) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 20.0),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          _buildTimeColumn(pass.departureTime, pass.departureCode),
          const Column(
            children: [
              Icon(Icons.flight, color: Colors.black),
              SizedBox(height: 4),
              Text(
                '13h00', // مدة الرحلة ثابتة
                style: TextStyle(color: Colors.black54),
              ),
            ],
          ),
          _buildTimeColumn(pass.arrivalTime, pass.arrivalCode),
        ],
      ),
    );
  }

  Widget _buildTimeColumn(String time, String code) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          time,
          style: const TextStyle(fontWeight: FontWeight.w500, fontSize: 20),
        ),
        Text(
          code,
          style: const TextStyle(color: Colors.black54),
        ),
      ],
    );
  }

  Widget _buildDetailsSection(pass) {
    return Column(
      children: [
        Divider(color: Colors.grey[300], height: 20),
        const SizedBox(height: 10),
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            _buildDetailColumn('8', 'Gate'),         // ثابت
            _buildDetailColumn(pass.seat, 'Seat'),   // من API
            _buildDetailColumn('3', 'Terminal'),     // ثابت
            _buildDetailColumn('AC006', 'Flight'),   // ثابت
          ],
        ),
        const SizedBox(height: 10),
      ],
    );
  }

  Widget _buildDetailColumn(String value, String label) {
    return Column(
      children: [
        Text(
          value,
          style: const TextStyle(
            fontWeight: FontWeight.normal,
            fontSize: 16,
            color: Colors.black54,
          ),
        ),
        Text(
          label,
          style: const TextStyle(color: Colors.black, fontWeight: FontWeight.w500),
        ),
      ],
    );
  }

  Widget _buildUserSection(pass) {
    return Row(
      children: [
        CircleAvatar(
          radius: 30,
          backgroundImage: NetworkImage(pass.userImage),
        ),
        const SizedBox(width: 16),
        Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              pass.userName,
              style: const TextStyle(fontWeight: FontWeight.w500, fontSize: 16),
            ),
            Text(
              '${pass.userAge} years, ${pass.userGender}',
              style: const TextStyle(color: Colors.black54),
            ),
          ],
        ),
        const Spacer(),
        const Icon(Icons.chair_outlined, color: AppColors.primaryColor),
        const SizedBox(width: 8),
        Text(
          pass.seat,
          style: const TextStyle(
            fontWeight: FontWeight.w500,
            fontSize: 14,
            color: Colors.black54,
          ),
        ),
      ],
    );
  }
}
